<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Revenue AI Use Cases Heatmap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 40px rgba(0,0,0,0.08);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 600;
            letter-spacing: -0.5px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            margin-top: 8px;
            font-size: 0.95em;
            opacity: 0.9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e4e8;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: #667eea;
        }
        
        .stat-number {
            font-size: 1.75em;
            font-weight: 700;
            color: #667eea;
            margin: 0;
            line-height: 1;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.8em;
            margin-top: 4px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .controls {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e1e4e8;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #374151;
            font-size: 0.85em;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.85em;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .filter-select:hover {
            border-color: #667eea;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        #reset-filters {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }
        
        #reset-filters:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .color-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            font-size: 0.85em;
            color: #6b7280;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-gradient {
            width: 120px;
            height: 20px;
            background: linear-gradient(to right, #f9fafb 0%, #dbeafe 25%, #93c5fd 50%, #3b82f6 75%, #1e40af 100%);
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }
        
        .visualization-container {
            padding: 20px 20px;
            overflow-x: auto;
        }
        
        #heatmap-container {
            display: flex;
            justify-content: center;
            min-width: fit-content;
        }
        
        .cell {
            cursor: pointer;
            stroke: white;
            stroke-width: 2px;
            transition: all 0.2s ease;
            rx: 4;
            ry: 4;
        }
        
        .cell:hover {
            stroke: #4b5563;
            stroke-width: 3px;
            filter: brightness(0.9) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transform: scale(1.05);
        }
        
        .axis-label {
            font-size: 12px;
            font-weight: 600;
            fill: #374151;
        }
        
        .y-axis-label {
            text-anchor: end;
            font-size: 12px;
            fill: #374151 !important;
        }
        
        .x-axis-label {
            text-anchor: middle;
            fill: #374151 !important;
        }
        
        .axis-title {
            font-size: 14px;
            font-weight: bold;
            fill: #374151 !important;
        }
        
        .cell-value {
            font-size: 16px;
            font-weight: 700;
            pointer-events: none;
        }
        
        .tooltip {
            position: absolute;
            padding: 12px 16px;
            background: rgba(17, 24, 39, 0.95);
            color: white;
            border-radius: 8px;
            pointer-events: none;
            font-size: 14px;
            line-height: 1.5;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .legend {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px 15px 20px;
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .legend-gradient {
            width: 180px;
            height: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 24px 30px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fafbfc;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1f2937;
            font-size: 1.5em;
        }
        
        .close {
            color: #6b7280;
            font-size: 28px;
            font-weight: 300;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #1f2937;
        }
        
        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .solution-item {
            border-bottom: 1px solid #f3f4f6;
            padding: 20px 0;
            transition: background 0.2s;
        }
        
        .solution-item:hover {
            background: #fafbfc;
            margin: 0 -30px;
            padding: 20px 30px;
        }
        
        .solution-item:last-child {
            border-bottom: none;
        }
        
        .solution-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .solution-meta {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 12px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .solution-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .solution-description {
            font-size: 14px;
            line-height: 1.6;
            color: #4b5563;
        }
        
        .solution-links {
            margin-top: 12px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .solution-links a {
            color: #667eea;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 6px 12px;
            border: 1px solid #667eea;
            border-radius: 6px;
            transition: all 0.2s;
            display: inline-block;
        }
        
        .solution-links a:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }
            
            .container {
                width: 100%;
                max-width: 100%;
                box-shadow: none;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .subtitle {
                font-size: 0.85em;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 15px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-number {
                font-size: 1.8em;
            }
            
            .filters {
                flex-direction: column;
                gap: 10px;
            }
            
            .legend {
                padding: 0 15px 10px 15px;
            }
            
            .legend-item {
                font-size: 11px;
                gap: 8px;
            }
            
            .legend-gradient {
                width: 140px;
                height: 16px;
            }
            
            .visualization-container {
                padding: 15px 5px;
                overflow-x: hidden;
            }
            
            #heatmap-container {
                overflow-x: hidden;
            }
            
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
            
            .axis-label {
                font-size: 10px;
            }
            
            .cell-value {
                font-size: 10px;
            }
            
            .tooltip {
                font-size: 12px;
            }
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 60px 20px;
            color: #ef4444;
        }
        
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 0 20px;
        }
        
        .view-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .view-btn:hover:not(.active) {
            background-color: #f3f4f6;
        }
        
        .word-cloud-container {
            padding: 20px;
            height: 500px;
            overflow: auto;
            text-align: center;
        }
        
        .word-cloud-word {
            display: inline-block;
            padding: 4px 8px;
            margin: 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            text-decoration: none;
            color: #1f2937;
        }
        
        .word-cloud-word:hover {
            background-color: #e5e7eb;
            transform: scale(1.1);
        }
        
        .word-cloud-word.selected {
            background-color: #3b82f6;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .grid-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .grid-item h3 {
            color: white;
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }

        .grid-item span {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .grid-item:hover {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        
        .filter-info {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin: 1rem 0;
            font-size: 0.9rem;
        }
        
        .view-toggle {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgb(59, 130, 246);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
        }
        
        .view-toggle:hover {
            background: rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .view-toggle.active {
            background: rgba(59, 130, 246, 0.6);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .axis-label {
            font-size: 12px;
            fill: #374151 !important;
            opacity: 1 !important;
            font-weight: 500;
        }
        
        /* Ensure SVG text is visible */
        svg text.cell-value {
            /* Only apply to cell values, not axis labels */
        }
        
        .heatmap-cell {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .heatmap-cell:hover {
            filter: brightness(0.9) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            transform: scale(1.05);
        }
        
        .cell {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .cell:hover {
            stroke-width: 3 !important;
            filter: brightness(1.1);
        }

        #view-toggle {
            background-color: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #view-toggle:hover {
            background-color: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
        
        .view-toggle-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        #mobile-hint {
            display: none;
            text-align: center;
            padding: 10px;
            background-color: #fef3c7;
            color: #92400e;
            font-size: 0.85em;
            margin: 10px 20px;
            border-radius: 6px;
            border: 1px solid #fcd34d;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: none;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #modal-title {
            font-size: 1.4em;
            font-weight: 600;
            margin: 0;
        }
        
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            transition: transform 0.2s;
            cursor: pointer;
            line-height: 1;
        }
        
        .close:hover,
        .close:focus {
            transform: scale(1.2);
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Revenue AI Use Cases Heatmap</h1>
            <div class="subtitle">Interactive visualization of AI solutions built by Revenue teams</div>
            <div class="view-toggle-container">
                <button id="viewToggle" class="view-toggle" onclick="toggleView()">
                    üìä Switch to Type View
                </button>
            </div>
        </div>
        
        <div class="stats" id="stats-container">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <div class="controls">
            <div class="filters">
                <div class="filter-group">
                    <label for="region-filter">Region:</label>
                    <select id="region-filter" class="filter-select">
                        <option value="all">All Regions</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="date-filter">Time Period:</label>
                    <select id="date-filter" class="filter-select">
                        <option value="all">All Time</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <button id="reset-filters">Reset Filters</button>
            </div>
            
            <div class="color-legend">
                <div class="legend-item">
                    <span>Low Activity</span>
                    <div class="legend-gradient"></div>
                    <span>High Activity</span>
                </div>
            </div>
        </div>
        
        <div class="visualization-container">
            <p id="mobile-hint" style="display: none; text-align: center; color: #6b7280; font-size: 12px; margin: 0 0 10px 0;">
                Tap once to preview, tap again to view details
            </p>
            <div id="heatmap-container">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading visualization...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tooltip"></div>
    
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title"></h2>
                <span class="close">&times;</span>
            </div>
            <div class="view-toggle">
                <button id="list-view-btn" class="view-btn active">List View</button>
                <button id="cloud-view-btn" class="view-btn">Word Cloud</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
            <div id="word-cloud" class="word-cloud-container" style="display: none;"></div>
        </div>
    </div>

    
    <script>
        // Load data and initialize visualization
        let globalData = null;
        let currentData = null;
        let csvData = [];
        let currentView = null;
        let currentListFilters = new Set();
        let lastTappedCell = null;
        let tapTimeout = null;
        let jobsData = null;
        let isTaskView = true; // Default to task view
        const tooltip = d3.select('.tooltip');
        
        // Role name mappings - must match exactly what's in the JSON
        const roleNameMap = {
            'Account Executive': 'Sales',
            'Launch Consultant': 'Launch',
            'MSM': 'CSM',
            'Operations': 'Ops',
            'Partnerships': 'Partner',
            'Solution Engineer': 'SE',
            'SDR': 'SDR',
            'Sales Development Rep': 'SDR',
            'ProServe (not in list, so excluded)': 'ProServe'
        };
        
        // Task name mappings (from jobs)
        const taskNameMap = {
            'Content Generation & Localization': 'Content Gen',
            'Account Intelligence & Research': 'Intel/Research',
            'Sales Process Optimization': 'Process Optimization',
            'Product & Demo Creation': 'Prod/Demo Creation',
            'Knowledge Centralization': 'Knowledge Mgmt',
            'Data Analysis & Reporting': 'Data/Reporting',
            'Workflow Automation': 'Automation',
            'Communication & Outreach': 'Outreach',
            'Learning & Training': 'Learning',
            'Partner & Collaboration': 'Partner',
            'Other': 'Other'
        };
        
        // Use absolute URL to ensure it works on GitHub Pages
        const dataUrl = window.location.hostname === 'pomajp.github.io' 
            ? 'https://pomajp.github.io/revai-heatmap/revai-data.json'
            : 'revai-data.json';
            
        const jobsDataUrl = window.location.hostname === 'pomajp.github.io' 
            ? 'https://pomajp.github.io/revai-heatmap/revai-jobs-data.json'
            : 'revai-jobs-data.json';
        
        console.log('Hostname:', window.location.hostname);
        console.log('Loading data from:', dataUrl);
        
        // Load data and create initial heatmap
        Promise.all([
            fetch(dataUrl).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            }),
            fetch(jobsDataUrl).then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
        ])
            .then(([typeData, taskData]) => {
                console.log('=== Data Loaded Successfully ===');
                console.log('Type view data:', typeData);
                console.log('Task view data:', taskData);
                
                globalData = typeData;
                currentData = typeData;
                csvData = typeData.allEntries || [];
                jobsData = taskData;
                
                console.log('Total entries in type data:', typeData.totalEntries);
                console.log('Total entries in task data:', taskData.totalEntries);
                console.log('All entries length:', csvData.length);
                
                initializeFilters(typeData);
                
                // Show the tasks view by default
                updateStats(taskData);
                createTasksHeatmap(taskData);
                
                // Verify data consistency
                console.log('=== Data Consistency Check ===');
                const taskSum = Object.values(taskData.jobCounts).reduce((a, b) => a + b, 0);
                console.log('Sum of all task counts:', taskSum);
                console.log('Should equal total entries:', taskData.totalEntries);
                
                // Check role distribution
                const roleSum = Object.values(taskData.roleCounts || {}).reduce((a, b) => a + b, 0);
                console.log('Sum of all role counts:', roleSum);
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('heatmap-container').innerHTML = 
                    `<div class="error">Error loading data: ${error.message}<br>Please try refreshing the page.</div>`;
            });
        
        function initializeFilters(data) {
            // Populate region filter
            const regions = [...new Set(data.allEntries.map(e => e.region).filter(r => r))];
            const regionSelect = document.getElementById('region-filter');
            regions.sort().forEach(region => {
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            // Add event listeners
            document.getElementById('region-filter').addEventListener('change', applyFilters);
            document.getElementById('date-filter').addEventListener('change', applyFilters);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
        }
        
        function applyFilters() {
            const regionFilter = document.getElementById('region-filter').value;
            const dateFilter = parseInt(document.getElementById('date-filter').value);
            
            console.log('=== Applying Filters ===');
            console.log('Region filter:', regionFilter);
            console.log('Date filter:', dateFilter);
            
            let filteredEntries = globalData.allEntries;
            console.log('Starting with', filteredEntries.length, 'total entries');
            
            // Apply region filter
            if (regionFilter !== 'all') {
                filteredEntries = filteredEntries.filter(e => e.region === regionFilter);
                console.log('After region filter:', filteredEntries.length, 'entries');
            }
            
            // Apply date filter
            if (!isNaN(dateFilter)) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - dateFilter);
                filteredEntries = filteredEntries.filter(e => {
                    const entryDate = new Date(e.updatedAt);
                    return entryDate >= cutoffDate;
                });
                console.log('After date filter:', filteredEntries.length, 'entries');
            }
            
            // Rebuild heatmap data
            const newHeatmapData = {};
            const newRoleCounts = {};
            const newSolutionCounts = {};
            
            filteredEntries.forEach(entry => {
                entry.roles.forEach(role => {
                    if (!newHeatmapData[role]) newHeatmapData[role] = {};
                    if (!newHeatmapData[role][entry.solutionType]) {
                        newHeatmapData[role][entry.solutionType] = 0;
                    }
                    newHeatmapData[role][entry.solutionType]++;
                    newRoleCounts[role] = (newRoleCounts[role] || 0) + 1;
                });
                newSolutionCounts[entry.solutionType] = (newSolutionCounts[entry.solutionType] || 0) + 1;
            });
            
            // Get updated unique roles and solution types
            const activeRoles = Object.keys(newRoleCounts).sort();
            const activeSolutionTypes = Object.keys(newSolutionCounts).sort();
            
            currentData = {
                ...globalData,
                matrix: newHeatmapData,
                roleCounts: newRoleCounts,
                solutionCounts: newSolutionCounts,
                totalEntries: filteredEntries.length,
                allEntries: filteredEntries,
                roles: activeRoles.length > 0 ? activeRoles : globalData.roles,
                solutionTypes: activeSolutionTypes.length > 0 ? activeSolutionTypes : globalData.solutionTypes
            };
            
            currentData = filteredData;
            
            // Update view based on current mode
            if (isTaskView) {
                updateStats(jobsData);
                createTasksHeatmap(jobsData);
            } else {
            updateStats(currentData);
                createTypeHeatmap(currentData);
            }
        }
        
        function resetFilters() {
            document.getElementById('region-filter').value = 'all';
            document.getElementById('date-filter').value = 'all';
            currentData = globalData;
            
            if (isTaskView) {
                updateStats(jobsData);
                createTasksHeatmap(jobsData);
            } else {
            updateStats(globalData);
                createTypeHeatmap(globalData);
        }
        }
        

        
        function createTypeHeatmap(data) {
            // Clear existing heatmap
            d3.select("#heatmap-container").selectAll("*").remove();
            
            // Show mobile hint if on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('mobile-hint').style.display = 'block';
            }
            
            // Dynamically adjust cell size based on viewport
            const viewportWidth = window.innerWidth;
            const containerWidth = document.getElementById('heatmap-container').offsetWidth;
            
            // Calculate cell size similar to tasks view
            let cellSize;
            let margin;
            
            if (viewportWidth < 768) {
                // Mobile
                cellSize = 40;
                margin = { top: 120, right: 40, bottom: 150, left: 180 };
            } else {
                // Desktop
                cellSize = 60;
                margin = { top: 150, right: 40, bottom: 150, left: 220 };
            }
            
            const width = Math.max(containerWidth, data.roles.length * cellSize + margin.left + margin.right);
            const height = data.solutionTypes.length * cellSize + margin.top + margin.bottom;
            
            // Create SVG
            const svg = d3.select("#heatmap-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // Create scales - roles on X, types on Y
            const xScale = d3.scaleBand()
                .domain(data.roles)
                .range([0, data.roles.length * cellSize])
                .padding(0.05);
            
            const yScale = d3.scaleBand()
                .domain(data.solutionTypes)
                .range([0, data.solutionTypes.length * cellSize])
                .padding(0.05);
            
            // Find max value for color scale
            let maxValue = 0;
            Object.values(data.matrix || {}).forEach(solutionTypes => {
                Object.values(solutionTypes).forEach(value => {
                    maxValue = Math.max(maxValue, value);
                });
            });
            
            // Color scale with better gradients
            const colorScale = d3.scaleSequential()
                .domain([0, maxValue])
                .interpolator(t => d3.interpolateBlues(t * 0.9 + 0.1)); // Avoid pure white
            
            // Create cells - roles on X, types on Y
                data.solutionTypes.forEach((solutionType, j) => {
                data.roles.forEach((role, i) => {
                    const value = (data.matrix && data.matrix[role] && data.matrix[role][solutionType]) || 0;
                    
                    const cell = g.append("rect")
                        .attr("x", xScale(role))
                        .attr("y", yScale(solutionType))
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth())
                        .attr("class", "cell")
                        .attr("rx", 4)
                        .attr("ry", 4)
                        .style("fill", value === 0 ? "#f9fafb" : colorScale(value))
                        .style("cursor", value > 0 ? "pointer" : "default")
                        .style("stroke", "white")
                        .style("stroke-width", 2)
                        .on("mouseover", function(event) {
                            if (value > 0) {
                                d3.select(this)
                                    .transition()
                                    .duration(100)
                                    .style("filter", "brightness(0.9) drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1))")
                                    .style("transform", "scale(1.05)");
                            }
                            showTooltip(event, role, solutionType, value);
                        })
                        .on("mouseout", function() {
                            if (value > 0) {
                                d3.select(this)
                                    .transition()
                                    .duration(100)
                                    .style("filter", "none")
                                    .style("transform", "scale(1)");
                            }
                            if (window.innerWidth > 768) {
                                hideTooltip();
                            }
                        })
                        .on("click", function(event) {
                            if (window.innerWidth <= 768) {
                                // Mobile behavior: two-tap
                                const cellKey = `${role}-${solutionType}`;
                                
                                if (lastTappedCell === cellKey) {
                                    // Second tap - open details
                            showDetails(role, solutionType, data);
                                    lastTappedCell = null;
                                    hideTooltip();
                                } else {
                                    // First tap - show tooltip
                                    lastTappedCell = cellKey;
                                    showTooltip(event, role, solutionType, value);
                                    
                                    // Clear previous timeout
                                    if (tapTimeout) clearTimeout(tapTimeout);
                                    
                                    // Hide tooltip after 3 seconds
                                    tapTimeout = setTimeout(() => {
                                        hideTooltip();
                                        lastTappedCell = null;
                                    }, 3000);
                                }
                            } else {
                                // Desktop behavior - immediate open
                                showDetails(role, solutionType, data);
                            }
                        });
                    
                    // Add text label for non-zero values
                    if (value > 0) {
                        g.append("text")
                            .attr("x", xScale(role) + xScale.bandwidth() / 2)
                            .attr("y", yScale(solutionType) + yScale.bandwidth() / 2)
                            .attr("text-anchor", "middle")
                            .attr("dominant-baseline", "middle")
                            .attr("class", "cell-value")
                            .style("fill", value > maxValue * 0.5 ? "white" : "#1f2937")
                            .style("pointer-events", "none")
                            .style("font-size", viewportWidth < 768 ? "14px" : "16px")
                            .style("font-weight", "700")
                            .text(value);
                    }
                });
            });
            
            // Add x-axis labels - roles at the bottom
            g.selectAll(".x-axis-label")
                .data(data.roles)
                .enter()
                .append("text")
                .attr("class", "x-axis-label axis-label")
                .attr("x", d => xScale(d) + xScale.bandwidth() / 2)
                .attr("y", data.solutionTypes.length * cellSize + 15)
                .attr("transform", d => {
                    const x = xScale(d) + xScale.bandwidth() / 2;
                    const y = data.solutionTypes.length * cellSize + 15;
                    return `rotate(45, ${x}, ${y})`;
                })
                .style("text-anchor", "start")
                .style("font-size", viewportWidth < 768 ? "10px" : "12px")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-weight", "600")
                .text(d => {
                    const label = roleNameMap[d] || d;
                    console.log(`Type view X-axis label for ${d}: ${label}`);
                    return label;
                });
            
            // Add y-axis labels - solution types on the left
            g.selectAll(".y-axis-label")
                .data(data.solutionTypes)
                .enter()
                .append("text")
                .attr("class", "y-axis-label axis-label")
                .attr("x", -15)
                .attr("y", d => yScale(d) + yScale.bandwidth() / 2)
                .attr("dominant-baseline", "middle")
                .style("text-anchor", "end")
                .style("font-size", viewportWidth < 768 ? "10px" : "12px")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-weight", "600")
                .text(d => {
                    const label = solutionTypeMap[d] || d;
                    console.log(`Type view Y-axis label for ${d}: ${label}`);
                    return label;
                });
                
            // Add axis titles
            // Y-axis title (Types)
            svg.append("text")
                .attr("class", "axis-title")
                .attr("transform", "rotate(-90)")
                .attr("y", margin.left / 3)
                .attr("x", -(data.solutionTypes.length * cellSize + margin.top) / 2)
                .attr("text-anchor", "middle")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text("Solution Types");
                
            // X-axis title (Roles)
            svg.append("text")
                .attr("class", "axis-title")
                .attr("x", margin.left + (data.roles.length * cellSize) / 2)
                .attr("y", margin.top + data.solutionTypes.length * cellSize + margin.bottom - 20)
                .attr("text-anchor", "middle")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text("Roles");
                
            // Debug logging for Type view
            console.log('=== Type View Heatmap Debug ===');
            console.log('Total entries:', data.totalEntries);
            console.log('Roles:', data.roles);
            console.log('Solution Types:', data.solutionTypes);
            console.log('Matrix:', data.matrix);
            
            // Log matrix totals
            let totalCells = 0;
            data.roles.forEach(role => {
                data.solutionTypes.forEach(type => {
                    const value = (data.matrix[role] && data.matrix[role][type]) || 0;
                    if (value > 0) {
                        totalCells += value;
                    }
                });
            });
            console.log('Total cell values:', totalCells);
        }
        
        // Define solutionTypeMap globally
        const solutionTypeMap = {
            'Application': 'App',
            'Workflow': 'Gumloop',
            'NotebookLM': 'NotebookLM',
            'Other': 'Other',
            'Prompt': 'Prompt',
            'Shared Librechat Agent': 'LibreChat',
            'Gumloop Workflow': 'Gumloop',
            'Shared LibreChat Agent': 'LibreChat'
        };
        
        function showTooltip(event, role, solutionType, value) {
            const tooltip = d3.select(".tooltip");
            const percentage = ((value / currentData.totalEntries) * 100).toFixed(1);
            const displayType = solutionTypeMap[solutionType] || solutionType;
            const displayRole = roleNameMap[role] || role;
            
            tooltip.html(`
                <strong>${displayRole}</strong><br/>
                <strong>${displayType}</strong><br/>
                Solutions: ${value}<br/>
                ${percentage}% of total
            `)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 28) + "px")
            .style("opacity", 1);
        }
        
        function hideTooltip() {
            d3.select(".tooltip").style("opacity", 0);
        }
        
        // Generic modal function for both views
        function showModal(title, entries) {
            const modal = document.getElementById("modal");
            const modalTitle = document.getElementById("modal-title");
            const modalBody = document.getElementById("modal-body");
            
            modalTitle.textContent = `${title} (${entries.length} solutions)`;
            
            // Sort entries by date in reverse chronological order (most recent first)
            entries.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            
            renderModalContent(entries, modalBody);
            
            modal.style.display = "block";
            document.getElementById('list-view-btn').classList.add('active');
            document.getElementById('cloud-view-btn').classList.remove('active');
            document.getElementById('word-cloud').style.display = 'none';
        }
        
        function showDetails(role, solutionType, data) {
            // Filter entries for this cell
            const relevantEntries = data.allEntries.filter(entry => 
                entry.roles.includes(role) && entry.solutionType === solutionType
            );
            
            const displayName = solutionTypeMap[solutionType] || solutionType;
            const displayRole = roleNameMap[role] || role;
            showModal(`${displayRole} - ${displayName}`, relevantEntries);
        }
            
        function renderModalContent(relevantEntries, modalBody) {
            const modal = document.getElementById("modal");
            
            // Build modal content
            let content = '';
            relevantEntries.forEach(entry => {
                const date = new Date(entry.updatedAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                content += `
                    <div class="solution-item">
                        <div class="solution-title">${entry.title || 'Untitled'}</div>
                        <div class="solution-meta">
                            <span>üë§ ${entry.author}</span>
                            <span>üåç ${entry.creatorRegion || 'Unknown Region'}</span>
                            <span>üìÖ ${date}</span>
                        </div>
                        <div class="solution-description">
                            ${entry.description ? entry.description.substring(0, 300) + (entry.description.length > 300 ? '...' : '') : 'No description available'}
                        </div>
                        <div class="solution-links">
                            ${entry.slackUrl && entry.slackUrl !== 'none' ? 
                                `<a href="${entry.slackUrl}" target="_blank">View in Slack</a>` : ''}
                            ${entry.videoUrl && entry.videoUrl !== 'none' ? 
                                `<a href="${entry.videoUrl}" target="_blank">Watch Video</a>` : ''}
                            ${entry.appUrl && entry.appUrl !== 'none' ? 
                                `<a href="${entry.appUrl}" target="_blank">View App</a>` : ''}
                        </div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = content;
            document.body.style.overflow = 'hidden';
            
            // Store current entries for word cloud
            modal.currentEntries = relevantEntries;
            
            // Setup view toggle event listeners
            setupViewToggle(relevantEntries);
        }
        
        // Modal close functionality
        document.querySelector(".close").onclick = function() {
            document.getElementById("modal").style.display = "none";
            document.body.style.overflow = 'auto';
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById("modal");
            if (event.target == modal) {
                modal.style.display = "none";
                document.body.style.overflow = 'auto';
            }
        }
        
        // Setup view toggle for list/word cloud
        function setupViewToggle(entries) {
            const listBtn = document.getElementById('list-view-btn');
            const cloudBtn = document.getElementById('cloud-view-btn');
            const modalBody = document.getElementById('modal-body');
            const wordCloud = document.getElementById('word-cloud');
            
            listBtn.onclick = function() {
                listBtn.classList.add('active');
                cloudBtn.classList.remove('active');
                modalBody.style.display = 'block';
                wordCloud.style.display = 'none';
            };
            
            cloudBtn.onclick = function() {
                cloudBtn.classList.add('active');
                listBtn.classList.remove('active');
                modalBody.style.display = 'none';
                wordCloud.style.display = 'block';
                generateWordCloud(entries);
            };
            
            // Reset to list view when modal opens
            listBtn.click();
        }
        
        // Generate word cloud from titles
        function generateWordCloud(entries) {
            const stopWords = new Set([
                'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for',
                'of', 'with', 'by', 'from', 'up', 'about', 'into', 'through', 'during',
                'before', 'after', 'above', 'below', 'between', 'under', 'again',
                'further', 'then', 'once', 'is', 'am', 'are', 'was', 'were', 'be',
                'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could',
                'should', 'may', 'might', 'must', 'can', 'this', 'that', 'these',
                'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'them', 'their',
                'what', 'which', 'who', 'when', 'where', 'why', 'how', 'all', 'each',
                'every', 'some', 'few', 'more', 'most', 'other', 'such', 'only', 'own',
                'same', 'so', 'than', 'too', 'very', 'just', 'now'
            ]);
            
            // Extract and count words from titles
            const wordCounts = {};
            entries.forEach(entry => {
                if (entry.title) {
                    // Split by non-word characters and filter
                    const words = entry.title.toLowerCase()
                        .split(/[^a-z0-9]+/)
                        .filter(word => word.length > 2 && !stopWords.has(word));
                    
                    words.forEach(word => {
                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                    });
                }
            });
            
            // Convert to array and sort by frequency
            const wordArray = Object.entries(wordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 50); // Top 50 words
            
            // Clear and generate cloud
            const cloudContainer = document.getElementById('word-cloud');
            cloudContainer.innerHTML = '';
            
            if (wordArray.length === 0) {
                cloudContainer.innerHTML = '<p style="color: #6b7280; padding: 40px;">No word data available</p>';
                return;
            }
            
            // Calculate font sizes
            const maxCount = wordArray[0][1];
            const minCount = wordArray[wordArray.length - 1][1];
            const sizeScale = d3.scaleLinear()
                .domain([minCount, maxCount])
                .range([14, 48]);
            
            // Create word elements
            wordArray.forEach(([word, count]) => {
                const span = document.createElement('span');
                span.className = 'word-cloud-word';
                span.textContent = word;
                span.style.fontSize = `${sizeScale(count)}px`;
                span.style.color = d3.interpolateBlues(count / maxCount);
                span.title = `${word}: ${count} occurrence${count > 1 ? 's' : ''}`;
                
                // Add click handler to filter
                span.onclick = function() {
                    filterByWord(word, entries);
                };
                
                cloudContainer.appendChild(span);
            });
        }
        
        // Filter solutions by clicked word
        function filterByWord(word, allEntries) {
            const modalBody = document.getElementById('modal-body');
            const listBtn = document.getElementById('list-view-btn');
            
            // Filter entries that contain the word in title
            const filteredEntries = allEntries.filter(entry => 
                entry.title && entry.title.toLowerCase().includes(word.toLowerCase())
            );
            
            // Switch to list view and show filtered results
            listBtn.click();
            
            // Rebuild the list with filtered entries
            let content = `<div style="padding: 10px 20px; background-color: #f3f4f6; margin-bottom: 10px; border-radius: 4px;">
                            Filtered by word: <strong>${word}</strong> (${filteredEntries.length} results)
                            <button onclick="resetFilter()" style="margin-left: 10px; padding: 4px 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer;">Clear Filter</button>
                          </div>`;
            
            filteredEntries.forEach(entry => {
                const date = new Date(entry.updatedAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                content += `
                    <div class="solution-item">
                        <div class="solution-title">${highlightWord(entry.title || 'Untitled', word)}</div>
                        <div class="solution-meta">
                            <span>üë§ ${entry.author}</span>
                            <span>üåç ${entry.region || 'Unknown Region'}</span>
                            <span>üìÖ ${date}</span>
                        </div>
                        <div class="solution-description">
                            ${entry.description ? entry.description.substring(0, 300) + (entry.description.length > 300 ? '...' : '') : 'No description available'}
                        </div>
                        <div class="solution-links">
                            ${entry.slackUrl && entry.slackUrl !== 'none' ? 
                                `<a href="${entry.slackUrl}" target="_blank">View in Slack</a>` : ''}
                            ${entry.videoUrl && entry.videoUrl !== 'none' ? 
                                `<a href="${entry.videoUrl}" target="_blank">Watch Video</a>` : ''}
                            ${entry.appUrl && entry.appUrl !== 'none' ? 
                                `<a href="${entry.appUrl}" target="_blank">View App</a>` : ''}
                        </div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = content;
        }
        
        // Highlight word in title
        function highlightWord(title, word) {
            const regex = new RegExp(`(${word})`, 'gi');
            return title.replace(regex, '<span style="background-color: #fbbf24; padding: 0 2px; border-radius: 2px;">$1</span>');
        }
        
        // Reset filter to show all entries
        function resetFilter() {
            const modal = document.getElementById("modal");
            const entries = modal.currentEntries;
            const modalBody = document.getElementById('modal-body');
            
            // Rebuild the original list
            let content = '';
            entries.forEach(entry => {
                const date = new Date(entry.updatedAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                content += `
                    <div class="solution-item">
                        <div class="solution-title">${entry.title || 'Untitled'}</div>
                        <div class="solution-meta">
                            <span>üë§ ${entry.author}</span>
                            <span>üåç ${entry.region || 'Unknown Region'}</span>
                            <span>üìÖ ${date}</span>
                        </div>
                        <div class="solution-description">
                            ${entry.description ? entry.description.substring(0, 300) + (entry.description.length > 300 ? '...' : '') : 'No description available'}
                        </div>
                        <div class="solution-links">
                            ${entry.slackUrl && entry.slackUrl !== 'none' ? 
                                `<a href="${entry.slackUrl}" target="_blank">View in Slack</a>` : ''}
                            ${entry.videoUrl && entry.videoUrl !== 'none' ? 
                                `<a href="${entry.videoUrl}" target="_blank">Watch Video</a>` : ''}
                            ${entry.appUrl && entry.appUrl !== 'none' ? 
                                `<a href="${entry.appUrl}" target="_blank">View App</a>` : ''}
                        </div>
                    </div>
                `;
            });
            
            modalBody.innerHTML = content;
        }
        
        // Responsive handling
        window.addEventListener('resize', () => {
            if (currentData) {
                createHeatmap(currentData);
            }
        });

        // Toggle between task and type view
        function toggleView() {
            isTaskView = !isTaskView;
            const toggle = document.getElementById('viewToggle');
            
            if (isTaskView) {
                toggle.textContent = 'üìä Switch to Type View';
                updateStats(jobsData);
                createTasksHeatmap(jobsData);
            } else {
                toggle.textContent = 'üìã Switch to Task View';
                updateStats(currentData);
                createTypeHeatmap(currentData);
            }
        }
        
        // Update stats based on current view
        function updateStats(data) {
            const statsContainer = document.getElementById('stats-container');
            
            if (isTaskView && data.jobCounts) {
                // Task view stats - show all tasks
                const allTasks = Object.entries(data.jobCounts)
                    .sort((a, b) => b[1] - a[1]);
                
                statsContainer.innerHTML = `
                    <div class="stat-card" onclick="showAllSolutions()" style="cursor: pointer;">
                        <p class="stat-number">${data.totalEntries}</p>
                        <p class="stat-label">Total Solutions</p>
                    </div>
                    ${allTasks.map(([task, count]) => `
                        <div class="stat-card" onclick="showTaskDetail('${task}')" style="cursor: pointer;">
                            <p class="stat-number">${count}</p>
                            <p class="stat-label" style="font-size: 0.8rem;">${taskNameMap[task] || task}</p>
                        </div>
                    `).join('')}
                `;
            } else {
                // Type view stats - show all roles
                const allRoles = data.roles.map(role => {
                    let count = 0;
                    data.solutionTypes.forEach(type => {
                        count += (data.matrix[role] && data.matrix[role][type]) || 0;
                    });
                    return [role, count];
                }).sort((a, b) => b[1] - a[1]);
                
                statsContainer.innerHTML = `
                    <div class="stat-card" onclick="showAllSolutions()" style="cursor: pointer;">
                        <p class="stat-number">${data.totalEntries}</p>
                        <p class="stat-label">Total Solutions</p>
                    </div>
                    ${allRoles.map(([role, count]) => `
                        <div class="stat-card" onclick="showRoleDetail('${role}')" style="cursor: pointer;">
                            <p class="stat-number">${count}</p>
                            <p class="stat-label" style="font-size: 0.8rem;">${roleNameMap[role] || role}</p>
                        </div>
                    `).join('')}
                `;
            }
        }
        
        // Create tasks-based heatmap (default view)
        function createTasksHeatmap(data) {
            console.log('Creating jobs heatmap with data:', data);
            
            // Clear existing heatmap
            d3.select("#heatmap-container").selectAll("*").remove();
            
            const container = document.getElementById("heatmap-container");
            const containerWidth = container.clientWidth;
            
            // Mobile detection
            const isMobile = window.innerWidth <= 768;
            
            // Calculate dimensions similar to default heatmap
            let cellSize = isMobile ? 40 : 60;
            const margin = { 
                top: isMobile ? 120 : 150, 
                right: 40, 
                bottom: isMobile ? 120 : 150, 
                left: isMobile ? 180 : 220 
            };
            
            const width = Math.max(containerWidth, data.roles.length * cellSize + margin.left + margin.right);
            const height = data.jobs.length * cellSize + margin.top + margin.bottom;
            
            // Create SVG
            const svg = d3.select("#heatmap-container")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);
            
            // Calculate dimensions - roles on X, tasks on Y
            const xScale = d3.scaleBand()
                .domain(data.roles)
                .range([0, data.roles.length * cellSize])
                .padding(0.05);
            
            const yScale = d3.scaleBand()
                .domain(data.jobs)
                .range([0, data.jobs.length * cellSize])
                .padding(0.05);
                
            console.log('Tasks:', data.jobs);
            console.log('Roles:', data.roles);
            console.log('Matrix:', data.matrix);
            
            // Color scale
            const maxValue = Math.max(...Object.values(data.matrix).flatMap(row => Object.values(row)));
            const colorScale = d3.scaleSequential()
                .domain([0, maxValue])
                .interpolator(d3.interpolateBlues);
            
            // Draw cells - iterate through all combinations
            data.jobs.forEach(task => {
                data.roles.forEach(role => {
                    const value = data.matrix[task]?.[role] || 0;
                    
                    const rect = g.append("rect")
                        .attr("x", xScale(role))
                        .attr("y", yScale(task))
                        .attr("width", xScale.bandwidth())
                        .attr("height", yScale.bandwidth())
                        .attr("fill", value > 0 ? colorScale(value) : 'rgba(255, 255, 255, 0.05)')
                        .attr("stroke", "white")
                        .attr("stroke-width", 1)
                        .attr("rx", 4)
                        .attr("class", "heatmap-cell");
                    
                    if (value > 0) {
                        rect.style("cursor", "pointer")
                            .on("click", function(event) {
                                showTaskRoleDetails(task, role);
                            })
                            .on("mouseover", function(event) {
                                const displayTask = taskNameMap[task] || task;
                                const displayRole = roleNameMap[role] || role;
                                const tooltip = d3.select('.tooltip');  // Add this line to ensure tooltip is in scope
                                tooltip.html(`<strong>${displayTask}</strong><br>${displayRole}<br>Solutions: ${value}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px")
                                    .style("opacity", 1);
                                d3.select(this).attr("stroke-width", 3);
                            })
                            .on("mousemove", function(event) {
                                const tooltip = d3.select('.tooltip');  // Add this line to ensure tooltip is in scope
                                tooltip.style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            })
                            .on("mouseout", function() {
                                const tooltip = d3.select('.tooltip');  // Add this line to ensure tooltip is in scope
                                tooltip.style("opacity", 0);
                                d3.select(this).attr("stroke-width", 1);
                            });
                    }
                });
            });
            
            // Add text labels for non-zero values
            data.jobs.forEach(task => {
                data.roles.forEach(role => {
                    const value = data.matrix[task]?.[role] || 0;
                    
                    if (value > 0) {
                        g.append("text")
                            .attr("x", xScale(role) + xScale.bandwidth() / 2)
                            .attr("y", yScale(task) + yScale.bandwidth() / 2)
                            .attr("text-anchor", "middle")
                            .attr("dominant-baseline", "middle")
                            .attr("class", "cell-value")
                            .style("fill", value > maxValue * 0.5 ? "white" : "#1f2937")
                            .style("pointer-events", "none")
                            .style("font-size", isMobile ? "14px" : "16px")
                            .style("font-weight", "700")
                            .text(value);
                    }
                });
            });
            
            // X axis - roles at the bottom
            g.append("g")
                .attr("transform", `translate(0, ${data.jobs.length * cellSize + 10})`)
                .selectAll("text")
                .data(data.roles)
                .enter().append("text")
                .attr("class", "x-axis-label axis-label")
                .attr("x", d => xScale(d) + xScale.bandwidth() / 2)
                .attr("y", 0)
                .attr("text-anchor", "start")
                .attr("transform", d => `rotate(45, ${xScale(d) + xScale.bandwidth() / 2}, 0)`)
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-size", isMobile ? "10px" : "12px")
                .style("font-weight", "600")
                .text(d => {
                    const label = roleNameMap[d] || d;
                    console.log(`X-axis label for ${d}: ${label}`);
                    return label;
                });
            
            // Y axis - tasks on the left
            g.append("g")
                .selectAll("text")
                .data(data.jobs)
                .enter().append("text")
                .attr("class", "y-axis-label axis-label")
                .attr("x", -10)
                .attr("y", d => yScale(d) + yScale.bandwidth() / 2)
                .attr("text-anchor", "end")
                .attr("dominant-baseline", "middle")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-size", isMobile ? "10px" : "12px")
                .style("font-weight", "600")
                .text(d => {
                    const label = taskNameMap[d] || d;
                    console.log(`Y-axis label for ${d}: ${label}`);
                    return label;
                });
                
            // Add axis titles
            // Y-axis title (Tasks)
            svg.append("text")
                .attr("class", "axis-title")
                .attr("transform", "rotate(-90)")
                .attr("y", margin.left / 3)
                .attr("x", -(height - margin.top - margin.bottom) / 2)
                .attr("text-anchor", "middle")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text("Tasks");
                
            // X-axis title (Roles)
            svg.append("text")
                .attr("class", "axis-title")
                .attr("x", margin.left + (data.roles.length * cellSize) / 2)
                .attr("y", height - margin.bottom / 3)
                .attr("text-anchor", "middle")
                .style("fill", "#374151")  // Changed from white to dark gray
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text("Roles");
                
            // Debug logging for matrix
            console.log('=== Tasks Heatmap Debug ===');
            console.log('Total entries:', data.totalEntries);
            console.log('Jobs:', data.jobs);
            console.log('Job counts:', data.jobCounts);
            console.log('Roles:', data.roles);
            console.log('Matrix:', data.matrix);
            
            // Log each cell's expected vs actual count
            data.jobs.forEach(job => {
                const expectedCount = data.jobCounts[job] || 0;
                const actualEntries = getEntriesForTask(job);
                console.log(`Job "${job}": Expected ${expectedCount}, Got ${actualEntries.length}`);
            });
        }
        
        // Helper function to get entries for a specific task
        function getEntriesForTask(task) {
            // Use the current view's data with pre-categorized jobs
            const entries = isTaskView ? (jobsData.allEntries || []) : (currentData.allEntries || []);
            
            console.log(`Getting entries for task "${task}" from ${entries.length} total entries`);
            
            // Use the pre-categorized job field
            const matchedEntries = entries.filter(entry => entry.job === task);
            
            console.log(`Found ${matchedEntries.length} entries for task "${task}"`);
            
            // Verify against expected count
            const expectedCount = jobsData.jobCounts[task] || 0;
            if (matchedEntries.length !== expectedCount) {
                console.warn(`‚ö†Ô∏è Count mismatch for "${task}": Found ${matchedEntries.length}, Expected ${expectedCount}`);
            }
            
            return matchedEntries;
        }
        
        // Show details for task-role combination
        function showTaskRoleDetails(task, role) {
            const taskEntries = getEntriesForTask(task);
            const filteredData = taskEntries.filter(item => {
                const itemRoles = item.roles.split(';').map(r => r.trim());
                return itemRoles.includes(role);
            });
            
            const expectedCount = jobsData.matrix[task] ? jobsData.matrix[task][role] || 0 : 0;
            console.log(`Task ${task} - Role ${role}: Expected ${expectedCount}, Got ${filteredData.length}`);
            
            const displayTask = taskNameMap[task] || task;
            const displayRole = roleNameMap[role] || role;
            showModal(`${displayTask} - ${displayRole}`, filteredData);
        }
        
        // Show task detail view
        function showTaskDetail(task) {
            const filteredData = getEntriesForTask(task);
            const displayTask = taskNameMap[task] || task;
            console.log(`Task ${task}: Expected ${jobsData.jobCounts[task]}, Got ${filteredData.length}`);
            showModal(`Task: ${displayTask}`, filteredData);
        }
        
        // Show role detail view
        function showRoleDetail(role) {
            const allEntries = currentData.allEntries || [];
            const filteredData = allEntries.filter(entry => {
                const entryRoles = entry.roles || [];
                return entryRoles.includes(role);
            });
            const displayRole = roleNameMap[role] || role;
            console.log(`Role ${role}: Found ${filteredData.length} entries`);
            showModal(`Role: ${displayRole}`, filteredData);
        }
        
        // List view functions
        function showAllSolutions() {
            // Show all solutions in the modal
            const allEntries = isTaskView ? jobsData.allEntries : currentData.allEntries;
            showModal('All Solutions', allEntries);
        }
        
        function showRolesList() {
            // This shows all solutions that have been tagged with roles
            // Each solution may have multiple roles
            const allEntries = isTaskView ? jobsData.allEntries : currentData.allEntries;
            showModal('All Solutions by Role', allEntries);
        }
        
        function showSolutionTypesList() {
            // This shows all solutions organized by their type
            const allEntries = isTaskView ? jobsData.allEntries : currentData.allEntries;
            showModal('All Solutions by Type', allEntries);
        }

    </script>
</body>
</html> 